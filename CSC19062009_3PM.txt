

ALTER TABLE STOREMASTER ADD OPT VARCHAR(1)
ALTER TABLE GRN_DETAILS ADD TAXPER NUMERIC(18,3)
ALTER TABLE GRN_DETAILS ADD TAXAMOUNT NUMERIC(18,3)

ALTER TABLE STOCKSUMMARY ADD RCVQTY1 NUMERIC(18,3)
ALTER TABLE STOCKSUMMARY ADD RCVRATE1 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD RCVVAL1 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD RCVQTY2 NUMERIC(18,3)
ALTER TABLE STOCKSUMMARY ADD RCVRATE2 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD RCVVAL2 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD RCVQTY3 NUMERIC(18,3)
ALTER TABLE STOCKSUMMARY ADD RCVRATE3 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD RCVVAL3 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD ISSQTY1 NUMERIC(18,3)
ALTER TABLE STOCKSUMMARY ADD ISSRATE1 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD ISSVAL1 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD ISSQTY2 NUMERIC(18,3)
ALTER TABLE STOCKSUMMARY ADD ISSRATE2 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD ISSVAL2 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD ISSQTY3 NUMERIC(18,3)
ALTER TABLE STOCKSUMMARY ADD ISSRATE3 NUMERIC(18,2)
ALTER TABLE STOCKSUMMARY ADD ISSVAL3 NUMERIC(18,2)


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


-- Exec Cp_StockSummary2 '01', '01 Apr 2008','31 Mar 2009','01 APR 2008',1

ALTER          PROCEDURE Cp_StockSummary2(@STORECODE As Varchar(20),@FROMDATE AS DATETIME, @TODATE AS DATETIME, @FINYEARSTART AS DATETIME,@OPTQTY NUMERIC (1))
AS
DECLARE @SSQL Varchar(2000),@SQL Varchar(2000),@ITEMCODE Varchar(500),@ITEMNAME Varchar(11),

@OPSTOCK NUMERIC(12,3),@OPVALUE NUMERIC(12,2),
@OPSTOCKVAL NUMERIC(12,3),
@ISSQTY NUMERIC(12,3),@ISSVAL NUMERIC(12,3),
@ISSQTY1 NUMERIC(12,3),@ISSVAL1 NUMERIC(12,3),
@ISSQTY2 NUMERIC(12,3),@ISSVAL2 NUMERIC(12,3),
@ISSQTY3 NUMERIC(12,3),@ISSVAL3 NUMERIC(12,3),

@RCVVAL NUMERIC(12,3),@RCVQTY NUMERIC(12,3),
@RCVVAL1 NUMERIC(12,3),@RCVQTY1 NUMERIC(12,3),
@RCVVAL2 NUMERIC(12,3),@RCVQTY2 NUMERIC(12,3),
@RCVVAL3 NUMERIC(12,3),@RCVQTY3 NUMERIC(12,3),

@STOCKUOM AS VARCHAR(15),@OUTFILE Varchar(10)


IF @STORECODE<>'MNS' AND @OPTQTY=1
BEGIN
UPDATE STOREMASTER SET OPT='Y' WHERE STORECODE<>'MNS'
UPDATE STOREMASTER SET OPT='N' WHERE STORECODE='MNS'
END
IF @STORECODE<>'MNS' AND @OPTQTY=0
BEGIN
UPDATE STOREMASTER SET OPT='Y' WHERE STORECODE=@STORECODE
UPDATE STOREMASTER SET OPT='N' WHERE STORECODE<>@STORECODE
END

SET @SSQL= 'DELETE FROM STOCKSUMMARY'
EXEC (@SSQL)
PRINT @STORECODE
Set @SSQL='INSERT INTO STOCKSUMMARY(ITEMCODE,ITEMNAME,UOM,VALUATION,OPQTY,OPVAL,STORECODE)'
Set @SSQL= @SSQL + ' SELECT I.ITEMCODE,I.ITEMNAME,I.STOCKUOM,I.VALUATION,ISNULL(I.OPSTOCK,0),ISNULL(I.OPVALUE,0),STORECODE FROM INVENTORYITEMMASTER AS I WHERE STORECODE IN (SELECT STORECODE FROM STOREMASTER WHERE OPT= ' + Char(39) + 'Y'  + Char(39) + ') ORDER BY I.ITEMCODE,I.STORECODE'
Print @SSQL
Exec (@SSQL)
set @SSQL=''
Set @SSQL='SELECT ITEMCODE,ITEMNAME,UOM,OPQTY,OPVAL,STORECODE FROM STOCKSUMMARY'

	set @SQL='DECLARE CURPROC CURSOR FOR ' + @ssql
	exec (@SQL)
	open CURPROC
	Fetch CURPROC into @ITEMCODE,@ITEMNAME,@STOCKUOM,@OPSTOCK,@OPVALUE,@STORECODE
	while @@fetch_Status=0
	Begin
		IF (SELECT STORESTATUS FROM STOREMASTER WHERE STORECODE=@STORECODE) = 'M' 
		   BEGIN
			
			SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(isnull(QTY,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE))
			SET @OPSTOCK = @OPSTOCK - (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKISSUEDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE))
			SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND TOSTORECODE =@STORECODE)
			SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(ISNULL(ADJUSTEDSTOCK,0)),0) FROM STOCKADJUSTDETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND STORELOCATIONCODE =@STORECODE)
			SET @OPSTOCK = @OPSTOCK - (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM SUBSTORECONSUMPTIONDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND STORELOCATIONCODE =@STORECODE)

			SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE))
			SET @OPVALUE = @OPVALUE - (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKISSUEDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE))
			SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND TOSTORECODE =@STORECODE)
			SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKADJUSTDETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND STORELOCATIONCODE =@STORECODE)
			SET @OPVALUE = @OPVALUE - (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM SUBSTORECONSUMPTIONDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND STORELOCATIONCODE =@STORECODE)

	
			PRINT @OPSTOCK
			
			Set @SQL = 'UPDATE STOCKSUMMARY SET OPQTY  =' + CONVERT(VARCHAR,@OPSTOCK) + ',OPVAL  =' + CONVERT(VARCHAR,@OPVALUE)
	 		SET @sql = @SQL + ' WHERE STOCKSUMMARY.ITEMCODE = ' + Char(39) + @ITEMCODE  + Char(39) + ''
			SET @SQL = @SQL + ' AND STORECODE =' + CHAR(39) + @STORECODE + CHAR(39) + ''
			PRINT @SQL
			Exec (@SQL)

			SET @RCVQTY1 = (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE BETWEEN @FROMDATE AND @TODATE)
			SET @RCVQTY2 =  (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND TOSTORECODE =@STORECODE)
			SET @RCVQTY3  =0

			SET @RCVQTY =@RCVQTY1 +@RCVQTY2 + @RCVQTY3
			PRINT @RCVQTY

			SET @RCVVAL1 = (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE BETWEEN @FROMDATE AND @TODATE)
			SET @RCVVAL2 = (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND TOSTORECODE =@STORECODE)
			SET @RCVVAL3  =0
			SET @RCVVAL =@RCVVAL1 +@RCVVAL2  + @RCVVAL3
			PRINT @RCVVAL
			
			Set @SQL = 'UPDATE STOCKSUMMARY SET RCVQTY  =' + CONVERT(VARCHAR,@RCVQTY) +',RCVQTY1  =' + CONVERT(VARCHAR,@RCVQTY1) +',RCVQTY2  =' + CONVERT(VARCHAR,@RCVQTY2)+',RCVQTY3  =' + CONVERT(VARCHAR,@RCVQTY3)
			Set @SQL = @SQL + ',RCVVAL  =' + CONVERT(VARCHAR,@RCVVAL) +',RCVVAL1  =' + CONVERT(VARCHAR,@RCVVAL1) +',RCVVAL2  =' + CONVERT(VARCHAR,@RCVVAL2)+',RCVVAL3  =' + CONVERT(VARCHAR,@RCVVAL3)
	 		SET @sql = @SQL + ' WHERE STOCKSUMMARY.ITEMCODE = ' + Char(39) + @ITEMCODE  + Char(39) + ''
			SET @SQL = @SQL + ' AND STORECODE =' + CHAR(39) + @STORECODE + CHAR(39) + ''
			PRINT @SQL
			Exec (@SQL)

			SET @ISSQTY1 = (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKISSUEDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE)
			SET @ISSQTY2 = (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM SUBSTORECONSUMPTIONDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND STORELOCATIONCODE =@STORECODE)
			SET @ISSQTY3 = (SELECT ISNULL(SUM(ISNULL(ADJUSTEDSTOCK,0)),0) FROM STOCKADJUSTDETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND STORELOCATIONCODE =@STORECODE)
			SET @ISSQTY = @ISSQTY1 + @ISSQTY2 - @ISSQTY3
			PRINT @ISSQTY


			SET @ISSVAL1 = (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKISSUEDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE)
			SET @ISSVAL2 = (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM SUBSTORECONSUMPTIONDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND STORELOCATIONCODE =@STORECODE)
			SET @ISSVAL3 = (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKADJUSTDETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND STORELOCATIONCODE =@STORECODE)
			SET @ISSVAL =@ISSVAL1 + @ISSVAL2 - @ISSVAL3
			PRINT @ISSVAL

			Set @SQL = 'UPDATE STOCKSUMMARY SET ISSQTY  =' + CONVERT(VARCHAR,@ISSQTY) + ',ISSQTY1  =' + CONVERT(VARCHAR,@ISSQTY1) + ',ISSQTY2  =' + CONVERT(VARCHAR,@ISSQTY2) + ',ISSQTY3  =' + CONVERT(VARCHAR,@ISSQTY3)
			Set @SQL = @SQL + ',ISSVAL  =' + CONVERT(VARCHAR,@ISSVAL) + ',ISSVAL1  =' + CONVERT(VARCHAR,@ISSVAL1) + ',ISSVAL2  =' + CONVERT(VARCHAR,@ISSVAL2) + ',ISSVAL3  =' + CONVERT(VARCHAR,@ISSVAL3)
	 		SET @sql = @SQL + ' WHERE STOCKSUMMARY.ITEMCODE = ' + Char(39) + @ITEMCODE  + Char(39) + ''
			SET @SQL = @SQL + ' AND STORECODE =' + CHAR(39) + @STORECODE + CHAR(39) + ''
			PRINT @SQL
			Exec (@SQL)

			Set @SQL='UPDATE STOCKSUMMARY SET CLSQTY  = ISNULL(OPQTY,0) + ISNULL(RCVQTY,0) - ISNULL(ISSQTY,0),CLSVAL  = ISNULL(OPVAL,0) + ISNULL(RCVVAL,0) - ISNULL(ISSVAL,0)'
	 		SET @sql= @SQL + ' WHERE STOCKSUMMARY.ITEMCODE = ' + Char(39) + @ITEMCODE  + Char(39) + ''
			SET @SQL = @SQL + ' AND STORECODE =' + CHAR(39) + @STORECODE + CHAR(39) + ''
			PRINT @SQL
			Exec (@SQL)


		   END
		ELSE
		   BEGIN  
			SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKISSUEDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND OPSTORELOCATIONCODE=@STORECODE)
			SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND TOSTORECODE =@STORECODE)
			SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(ISNULL(ADJUSTEDSTOCK,0)),0) FROM STOCKADJUSTDETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND STORELOCATIONCODE =@STORECODE)
			SET @OPSTOCK = @OPSTOCK - (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND FROMSTORECODE =@STORECODE)
			SET @OPSTOCK = @OPSTOCK - (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM SUBSTORECONSUMPTIONDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND STORELOCATIONCODE =@STORECODE)
			PRINT @OPSTOCK	

			SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKISSUEDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND OPSTORELOCATIONCODE =@STORECODE)
			SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND TOSTORECODE =@STORECODE)
			SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKADJUSTDETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND STORELOCATIONCODE =@STORECODE)
			SET @OPVALUE = @OPVALUE - (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND FROMSTORECODE =@STORECODE)
			SET @OPVALUE = @OPVALUE - (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM SUBSTORECONSUMPTIONDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND DateAdd(Day, -1,@FROMDATE) AND STORELOCATIONCODE =@STORECODE)
			PRINT @OPVALUE
		
			Set @SQL = 'UPDATE STOCKSUMMARY SET OPQTY  =' + CONVERT(VARCHAR,@OPSTOCK) + ',OPVAL  =' + CONVERT(VARCHAR,@OPVALUE)
	 		SET @sql = @SQL + ' WHERE STOCKSUMMARY.ITEMCODE = ' + Char(39) + @ITEMCODE  + Char(39) + ''
			SET @SQL = @SQL + ' AND STORECODE =' + CHAR(39) + @STORECODE + CHAR(39) + ''
			PRINT @SQL
			Exec (@SQL)

			SET @RCVQTY1 = (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKISSUEDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND OPSTORELOCATIONCODE =@STORECODE)
			SET @RCVQTY2 = (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND TOSTORECODE =@STORECODE)
			SET @RCVQTY3  =0
			SET @RCVQTY =@RCVQTY1 +@RCVQTY2  + @RCVQTY3

			PRINT @RCVQTY

			SET @RCVVAL1 = (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKISSUEDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND OPSTORELOCATIONCODE =@STORECODE)
			SET @RCVVAL2 = (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND TOSTORECODE =@STORECODE)
			SET @RCVVAL3  =0
			SET @RCVVAL =@RCVVAL1 +@RCVVAL2  + @RCVVAL3
			PRINT @RCVVAL

			Set @SQL = 'UPDATE STOCKSUMMARY SET RCVQTY  =' + CONVERT(VARCHAR,@RCVQTY) +',RCVQTY1  =' + CONVERT(VARCHAR,@RCVQTY1) +',RCVQTY2  =' + CONVERT(VARCHAR,@RCVQTY2)+',RCVQTY3  =' + CONVERT(VARCHAR,@RCVQTY3)
			Set @SQL = @SQL + ',RCVVAL  =' + CONVERT(VARCHAR,@RCVVAL) +',RCVVAL1  =' + CONVERT(VARCHAR,@RCVVAL1) +',RCVVAL2  =' + CONVERT(VARCHAR,@RCVVAL2)+',RCVVAL3  =' + CONVERT(VARCHAR,@RCVVAL3)
	 		SET @sql = @SQL + ' WHERE STOCKSUMMARY.ITEMCODE = ' + Char(39) + @ITEMCODE  + Char(39) + ''
			SET @SQL = @SQL + ' AND STORECODE =' + CHAR(39) + @STORECODE + CHAR(39) + ''
			PRINT @SQL
			Exec (@SQL)


			SET @ISSQTY1 = (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND FROMSTORECODE =@STORECODE)
			SET @ISSQTY2 = (SELECT ISNULL(SUM(ISNULL(QTY,0)),0) FROM SUBSTORECONSUMPTIONDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND STORELOCATIONCODE =@STORECODE)
			SET @ISSQTY3 = (SELECT ISNULL(SUM(ISNULL(ADJUSTEDSTOCK,0)),0) FROM STOCKADJUSTDETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND STORELOCATIONCODE =@STORECODE)
			SET @ISSQTY = @ISSQTY1 + @ISSQTY2 - @ISSQTY3

			PRINT @ISSQTY

			SET @ISSVAL1 = (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND FROMSTORECODE =@STORECODE)
			SET @ISSVAL2 =  (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM SUBSTORECONSUMPTIONDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND STORELOCATIONCODE =@STORECODE)
			SET @ISSVAL3 = (SELECT ISNULL(SUM(ISNULL(AMOUNT,0)),0) FROM STOCKADJUSTDETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FROMDATE AND @TODATE AND STORELOCATIONCODE =@STORECODE)
			SET @ISSVAL =@ISSVAL1 + @ISSVAL2 - @ISSVAL3
			PRINT @ISSVAL

			Set @SQL = 'UPDATE STOCKSUMMARY SET ISSQTY  =' + CONVERT(VARCHAR,@ISSQTY) + ',ISSQTY1  =' + CONVERT(VARCHAR,@ISSQTY1) + ',ISSQTY2  =' + CONVERT(VARCHAR,@ISSQTY2) + ',ISSQTY3  =' + CONVERT(VARCHAR,@ISSQTY3)
			Set @SQL = @SQL + ',ISSVAL  =' + CONVERT(VARCHAR,@ISSVAL) + ',ISSVAL1  =' + CONVERT(VARCHAR,@ISSVAL1) + ',ISSVAL2  =' + CONVERT(VARCHAR,@ISSVAL2) + ',ISSVAL3  =' + CONVERT(VARCHAR,@ISSVAL3)
	 		SET @sql = @SQL + ' WHERE STOCKSUMMARY.ITEMCODE = ' + Char(39) + @ITEMCODE  + Char(39) + ''
			SET @SQL = @SQL + ' AND STORECODE =' + CHAR(39) + @STORECODE + CHAR(39) + ''
			PRINT @SQL
			Exec (@SQL)

			Set @SQL='UPDATE STOCKSUMMARY SET CLSQTY  = ISNULL(OPQTY,0) + ISNULL(RCVQTY,0) - ISNULL(ISSQTY,0),CLSVAL  = ISNULL(OPVAL,0) + ISNULL(RCVVAL,0) - ISNULL(ISSVAL,0)'
	 		SET @sql= @SQL + ' WHERE STOCKSUMMARY.ITEMCODE = ' + Char(39) + @ITEMCODE  + Char(39) + ''
			SET @SQL = @SQL + ' AND STORECODE =' + CHAR(39) + @STORECODE + CHAR(39) + ''
			PRINT @SQL
			Exec (@SQL)

		     END
			
		Fetch CURPROC into @ITEMCODE,@ITEMNAME,@STOCKUOM,@OPSTOCK,@OPVALUE,@STORECODE
	End

	UPDATE stocksummary SET Opqty=ISNULL(Opqty,0)
	UPDATE stocksummary SET Oprate=ISNULL(Oprate,0)
	UPDATE stocksummary SET Opval=ISNULL(Opval,0)
	UPDATE stocksummary SET Rcvqty=ISNULL(Rcvqty,0)
	UPDATE stocksummary SET Rcvrate=ISNULL(Rcvrate,0)
	UPDATE stocksummary SET Rcvval=ISNULL(Rcvval,0)
	UPDATE stocksummary SET Issqty=ISNULL(Issqty,0)
	UPDATE stocksummary SET Issrate=ISNULL(Issrate,0)
	UPDATE stocksummary SET Issval=ISNULL(Issval,0)
	UPDATE stocksummary SET Clsqty=ISNULL(Clsqty,0)
	UPDATE stocksummary SET Clsrate=ISNULL(Clsrate,0)
	UPDATE stocksummary SET Clsval=ISNULL(Clsval,0)

	UPDATE STOCKSUMMARY SET OPRATE=OPVAL/OPQTY WHERE OPVAL<>0 and opqty<>0
	UPDATE STOCKSUMMARY SET RCVRATE=(RCVVAL)/(RCVQTY) WHERE RCVVAL<>0  and RCVQTY<>0
	UPDATE STOCKSUMMARY SET ISSRATE=ISSVAL/ISSQTY WHERE ISSVAL<>0 and issqty<>0
	UPDATE STOCKSUMMARY SET CLSRATE=CLSVAL/CLSQTY WHERE CLSVAL<>0 and clsqty<>0

	UPDATE stocksummary SET Opval=ISNULL(OpQTY,0)*ISNULL(OpRATE,0)
	UPDATE stocksummary SET RCVval=ISNULL(RCVQTY,0)*ISNULL(RCVRATE,0)
	UPDATE stocksummary SET ISSval=ISNULL(ISSQTY,0)*ISNULL(ISSRATE,0)
	UPDATE stocksummary SET CLSval=ISNULL(CLSQTY,0)*ISNULL(CLSRATE,0)



PRINT 'OVER'

--	delete from stocksummary where itemcode not in (select itemcode from GRN_DETAILS) or itemcode not in (select itemcode from inventoryitemmaster where isnull(opstock,0)<>0)

CLOSE CURPROC
DEALLOCATE CURPROC



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO







