SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

ALTER                   Trigger INV_TR_ItemBal ON dbo.grn_details
AFTER INSERT
AS
set nocount on
Declare @Itemcode Varchar(50), @DATE DATETIME,@FINYEARSTART DATETIME,CLSSTK AS NUMERIC(18,3),@STORECODE AS VARCHAR(10)
SET @FINYEARSTART='01-APR-2009'
SET @STORECODE='MNS'

Declare trcur cursor for Select Itemcode,grndate from Inserted group by Itemcode,month(grndate)
Open trcur
Fetch trcur into @itemcode,@DATE
while @@fetch_status=0
Begin
	SET @CLSSTK = @CLSSTK + (SELECT ISNULL(SUM(QTY),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE BETWEEN @FINYEARSTART AND @FROMDATE)
	SET @CLSSTK = @CLSSTK - (SELECT ISNULL(SUM(QTY),0) FROM STOCKISSUEDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND @FROMDATE)
	SET @CLSSTK = @CLSSTK + (SELECT ISNULL(SUM(QTY),0) FROM STOCKTRANSFERDETAIL WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND @FROMDATE AND TOSTORECODE=@STORECODE)
	SET @CLSSTK = @CLSSTK + (SELECT ISNULL(SUM(ADJUSTEDSTOCK),0) FROM STOCKADJUSTDETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND @FROMDATE AND STORELOCATIONCODE=@STORECODE)
	SET @CLSSTK = @CLSSTK - (SELECT ISNULL(SUM(QTY),0) FROM SUBSTORECONSUMPTIONDETAIL WHERE @PREFIX+ITEMCODE=@Itemcode AND ISNULL(VOID,'') <> 'Y' AND DOCDATE BETWEEN @FINYEARSTART AND @FROMDATE AND STORELOCATIONCODE=@STORECODE)
			
	Set @SQL = 'UPDATE INVENTORYITEMMASTER SET CLSTOCK  =' + CONVERT(VARCHAR,@CLSSTK)
	SET @sql = @SQL + ' WHERE STOCKSUMMARY.ITEMCODE = ' + Char(39) + @ITEMCODE  + Char(39) + ''
	SET @SQL = @SQL + ' AND STORECODE =' + CHAR(39) + @STORECODE + CHAR(39) + ''
	Exec (@SQL)

	Fetch trcur into @itemcode,@DATE
end
close trcur
deallocate trcur

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

