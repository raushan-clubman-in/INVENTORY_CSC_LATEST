SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


-- Exec Cp_WeightedAverage '01 Apr 2008','31 Mar 2009'

ALTER            PROCEDURE Cp_WeightedAverage(@FROMDATE AS VARCHAR(11), @TODATE AS VARCHAR(11))
AS
DECLARE @SSQL Varchar(2000),@SQL Varchar(2000),@ITEMCODE Varchar(20),
@OPSTOCK NUMERIC(12,3),@OPVALUE NUMERIC(12,2),
@DOCDATE AS DATETIME,@AUTOID AS NUMERIC(12)

PRINT 'STOCK ISSUE'

Set @SSQL='SELECT ITEMCODE,DOCDATE,AUTOID FROM STOCKISSUEDETAIL WHERE ISNULL(VOID,'+CHAR(39)+'N'+CHAR(39)+')<> ' + Char(39) + 'Y'  + Char(39) + ' AND DOCDATE BETWEEN '+CHAR(39)+@FROMDATE+CHAR(39)+' AND '+CHAR(39)+@TODATE+CHAR(39)+' ORDER BY AUTOID'
set @SQL='DECLARE CURPROC CURSOR FOR ' + @ssql
PRINT (@SQL)
exec (@SQL)
open CURPROC
Fetch CURPROC into @ITEMCODE,@DOCDATE,@AUTOID
while @@fetch_Status=0
Begin
	SET @OPSTOCK = (SELECT ISNULL(SUM(isnull(OPSTOCK,0)),0) FROM INVENTORYITEMMASTER WHERE ITEMCODE=@Itemcode AND ISNULL(FREEZE,'') <> 'Y' AND ISNULL(STORECODE,'')='MNS')
	SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(isnull(QTY,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE <= @DOCDATE)

	SET @OPVALUE = (SELECT ISNULL(SUM(isnull(OPVALUE,0)),0) FROM INVENTORYITEMMASTER WHERE ITEMCODE=@Itemcode AND ISNULL(FREEZE,'') <> 'Y' AND ISNULL(STORECODE,'')='MNS')
	SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(isnull(AMOUNT,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE <= @DOCDATE)
	PRINT @AUTOID
	PRINT @ITEMCODE
	PRINT @OPSTOCK
	PRINT @OPVALUE
	UPDATE STOCKISSUEDETAIL SET RATE=CASE WHEN @OPSTOCK>0 THEN ROUND(@OPVALUE/@OPSTOCK,2) ELSE 0 END WHERE AUTOID=@AUTOID 
	Fetch CURPROC into @ITEMCODE,@DOCDATE,@AUTOID
End
UPDATE STOCKISSUEDETAIL SET AMOUNT=QTY*RATE WHERE DOCDATE BETWEEN @FROMDATE AND @TODATE
CLOSE CURPROC
DEALLOCATE CURPROC

PRINT 'STOCK TRANSFER'
Set @SSQL='SELECT ITEMCODE,DOCDATE,AUTOID FROM STOCKTRANSFERDETAIL WHERE ISNULL(VOID,'+CHAR(39)+'N'+CHAR(39)+')<> ' + Char(39) + 'Y'  + Char(39) + ' AND DOCDATE BETWEEN '+CHAR(39)+@FROMDATE+CHAR(39)+' AND '+CHAR(39)+@TODATE+CHAR(39)+' ORDER BY AUTOID'
set @SQL='DECLARE CURPROC CURSOR FOR ' + @ssql
PRINT (@SQL)
exec (@SQL)
open CURPROC
Fetch CURPROC into @ITEMCODE,@DOCDATE,@AUTOID
while @@fetch_Status=0
Begin
	SET @OPSTOCK = (SELECT ISNULL(SUM(isnull(OPSTOCK,0)),0) FROM INVENTORYITEMMASTER WHERE ITEMCODE=@Itemcode AND ISNULL(FREEZE,'') <> 'Y' AND ISNULL(STORECODE,'')='MNS')
	SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(isnull(QTY,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE <= @DOCDATE)

	SET @OPVALUE = (SELECT ISNULL(SUM(isnull(OPVALUE,0)),0) FROM INVENTORYITEMMASTER WHERE ITEMCODE=@Itemcode AND ISNULL(FREEZE,'') <> 'Y' AND ISNULL(STORECODE,'')='MNS')
	SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(isnull(AMOUNT,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE <= @DOCDATE)
	PRINT @AUTOID
	PRINT @ITEMCODE
	PRINT @OPSTOCK
	PRINT @OPVALUE
	UPDATE STOCKTRANSFERDETAIL SET RATE=CASE WHEN @OPSTOCK>0 THEN ROUND(@OPVALUE/@OPSTOCK,2) ELSE 0 END WHERE AUTOID=@AUTOID 
	Fetch CURPROC into @ITEMCODE,@DOCDATE,@AUTOID
End
UPDATE STOCKTRANSFERDETAIL SET AMOUNT=QTY*RATE WHERE DOCDATE BETWEEN @FROMDATE AND @TODATE
CLOSE CURPROC
DEALLOCATE CURPROC


PRINT 'STOCK ADJUST'
Set @SSQL='SELECT ITEMCODE,DOCDATE,AUTOID FROM STOCKADJUSTDETAILS WHERE ISNULL(VOID,'+CHAR(39)+'N'+CHAR(39)+')<> ' + Char(39) + 'Y'  + Char(39) + ' AND DOCDATE BETWEEN '+CHAR(39)+@FROMDATE+CHAR(39)+' AND '+CHAR(39)+@TODATE+CHAR(39)+' ORDER BY AUTOID'
set @SQL='DECLARE CURPROC CURSOR FOR ' + @ssql
PRINT (@SQL)
exec (@SQL)
open CURPROC
Fetch CURPROC into @ITEMCODE,@DOCDATE,@AUTOID
while @@fetch_Status=0
Begin
	SET @OPSTOCK = (SELECT ISNULL(SUM(isnull(OPSTOCK,0)),0) FROM INVENTORYITEMMASTER WHERE ITEMCODE=@Itemcode AND ISNULL(FREEZE,'') <> 'Y' AND ISNULL(STORECODE,'')='MNS')
	SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(isnull(QTY,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE <= @DOCDATE)

	SET @OPVALUE = (SELECT ISNULL(SUM(isnull(OPVALUE,0)),0) FROM INVENTORYITEMMASTER WHERE ITEMCODE=@Itemcode AND ISNULL(FREEZE,'') <> 'Y' AND ISNULL(STORECODE,'')='MNS')
	SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(isnull(AMOUNT,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE <= @DOCDATE)
	PRINT @AUTOID
	PRINT @ITEMCODE
	PRINT @OPSTOCK
	PRINT @OPVALUE
	UPDATE STOCKADJUSTDETAILS SET RATE=CASE WHEN @OPSTOCK>0 THEN ROUND(@OPVALUE/@OPSTOCK,2) ELSE 0 END WHERE AUTOID=@AUTOID 
	Fetch CURPROC into @ITEMCODE,@DOCDATE,@AUTOID
End
UPDATE STOCKADJUSTDETAILS SET AMOUNT=ADJUSTEDSTOCK*RATE WHERE DOCDATE BETWEEN @FROMDATE AND @TODATE
CLOSE CURPROC
DEALLOCATE CURPROC


PRINT 'SUB STORE CONSUMPTION'
Set @SSQL='SELECT ITEMCODE,DOCDATE,AUTOID FROM SUBSTORECONSUMPTIONDETAIL WHERE ISNULL(VOID,'+CHAR(39)+'N'+CHAR(39)+')<> ' + Char(39) + 'Y'  + Char(39) + ' AND DOCDATE BETWEEN '+CHAR(39)+@FROMDATE+CHAR(39)+' AND '+CHAR(39)+@TODATE+CHAR(39)+' ORDER BY AUTOID'
set @SQL='DECLARE CURPROC CURSOR FOR ' + @ssql
PRINT (@SQL)
exec (@SQL)
open CURPROC
Fetch CURPROC into @ITEMCODE,@DOCDATE,@AUTOID
while @@fetch_Status=0
Begin
	SET @OPSTOCK = (SELECT ISNULL(SUM(isnull(OPSTOCK,0)),0) FROM INVENTORYITEMMASTER WHERE ITEMCODE=@Itemcode AND ISNULL(FREEZE,'') <> 'Y' AND ISNULL(STORECODE,'')='MNS')
	SET @OPSTOCK = @OPSTOCK + (SELECT ISNULL(SUM(isnull(QTY,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE <= @DOCDATE)

	SET @OPVALUE = (SELECT ISNULL(SUM(isnull(OPVALUE,0)),0) FROM INVENTORYITEMMASTER WHERE ITEMCODE=@Itemcode AND ISNULL(FREEZE,'') <> 'Y' AND ISNULL(STORECODE,'')='MNS')
	SET @OPVALUE = @OPVALUE + (SELECT ISNULL(SUM(isnull(AMOUNT,0)),0) FROM GRN_DETAILS WHERE ITEMCODE=@Itemcode AND ISNULL(VOIDITEM,'') <> 'Y' AND GRNDATE <= @DOCDATE)
	PRINT @AUTOID
	PRINT @ITEMCODE
	PRINT @OPSTOCK
	PRINT @OPVALUE
	UPDATE SUBSTORECONSUMPTIONDETAIL SET RATE=CASE WHEN @OPSTOCK>0 THEN ROUND(@OPVALUE/@OPSTOCK,2) ELSE 0 END WHERE AUTOID=@AUTOID 
	Fetch CURPROC into @ITEMCODE,@DOCDATE,@AUTOID
End
UPDATE SUBSTORECONSUMPTIONDETAIL SET AMOUNT=QTY*RATE WHERE DOCDATE BETWEEN @FROMDATE AND @TODATE
CLOSE CURPROC
DEALLOCATE CURPROC

PRINT 'OVER'



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

-- Exec Cp_Substoreconsumption '01 Apr 2009','26 Jun 2009'

ALTER        PROCEDURE Cp_Substoreconsumption(@FROMDATE AS VARCHAR(11), @TODATE AS VARCHAR(11))
AS
DECLARE @SSQL Varchar(2000),@SQL Varchar(2000),
@POSCODE AS VARCHAR(50),
@KOTNO AS VARCHAR(50),
@KOTDETAILS AS VARCHAR(50),
@KOTDATE AS varchar(11),
@ITEMCODE AS VARCHAR(50),
@ITEMDESC AS VARCHAR(100),
@UOM AS VARCHAR(50),
@DELFLAG AS VARCHAR(1),
@GROUPCODE AS VARCHAR(50),
@SUBGROUPCODE AS VARCHAR(50)
DECLARE @QTY AS numeric(18,3),@RATE AS numeric(18,2),@AMOUNT AS NUMERIC(18,2)

Set @SSQL='DELETE SUBSTORECONSUMPTIONDETAIL WHERE CAST(CONVERT(CHAR(39),DOCDATE,106) AS DATETIME) BETWEEN '+CHAR(39)+@FROMDATE+CHAR(39)+' AND '+CHAR(39)+@TODATE +CHAR(39)
PRINT (@SSQL)
exec (@SSQL)
SET @SSQL=''
Set @SSQL='SELECT ISNULL(D.GROUPCODE,'+CHAR(39)+''+CHAR(39)+') AS GROUPCODE,ISNULL(D.SUBGROUPCODE,'+CHAR(39)+''+CHAR(39)+') AS SUBGROUPCODE,ISNULL(A.POSCODE,'+CHAR(39)+''+CHAR(39)+') AS POSCODE,ISNULL(A.KOTNO,'+CHAR(39)+''+CHAR(39)+') AS KOTNO,ISNULL(A.KOTDETAILS,'+CHAR(39)+''+CHAR(39)+') AS KOTDETAILS,CAST(CONVERT(CHAR(39),ISNULL(A.KOTDATE,'+CHAR(39)+''+CHAR(39)+'),106) AS DATETIME) AS KOTDATE,ISNULL(A.ITEMCODE,'+CHAR(39)+''+CHAR(39)+') AS ITEMCODE,ISNULL(A.ITEMDESC,'+CHAR(39)+''+CHAR(39)+') AS ITEMDESC,ISNULL(A.UOM,'+CHAR(39)+''+CHAR(39)+') AS UOM,ISNULL(A.QTY,0) AS QTY,ISNULL(A.RATE,0) AS RATE,ISNULL(A.AMOUNT,0) AS AMOUNT,ISNULL(A.DELFLAG,'+CHAR(39)+''+CHAR(39)+') AS DELFLAG FROM KOT_DET A,INVENTORYITEMMASTER D,STOREMASTER B WHERE D.STORECODE='+CHAR(39)+'MNS'+CHAR(39)+' AND D.ITEMCODE=A.ITEMCODE AND D.SALEUOM=A.UOM AND A.POSCODE=B.STORECODE AND ISNULL(A.KOTSTATUS,'+CHAR(39)+'N'+CHAR(39)+')='+CHAR(39)+'N'+CHAR(39)+' AND ISNULL(A.DELFLAG,'+CHAR(39)+''+CHAR(39)+')<>'+CHAR(39)+'Y'+CHAR(39) +'AND A.KOTDATE BETWEEN '+CHAR(39)+@FROMDATE+CHAR(39)+' AND '+CHAR(39)+@TODATE +CHAR(39) + ' AND A.ITEMCODE+A.UOM NOT IN (SELECT ITEMCODE+ITEMUOM FROM BOM_DET C WHERE C.ITEMCODE=A.ITEMCODE AND C.ITEMUOM=A.UOM AND ISNULL(C.VOID,'+CHAR(39)+''+CHAR(39)+')<>'+CHAR(39)+'Y'+CHAR(39)+') ORDER BY A.ITEMCODE '
set @SQL='DECLARE CURPROC CURSOR FOR ' + @ssql
PRINT (@SQL)
exec (@SQL)
open CURPROC
Fetch CURPROC into @GROUPCODE,@SUBGROUPCODE,@POSCODE,@KOTNO,@KOTDETAILS,@KOTDATE,@ITEMCODE,@ITEMDESC,@UOM,@QTY,@RATE,@AMOUNT,@DELFLAG
while @@fetch_Status=0
Begin
	SET @SSQL=''
	Set @SSQL='INSERT INTO SUBSTORECONSUMPTIONDETAIL(Docno,Docdetails,Docdate,Storelocationcode,STORELOCATIONNAME,Itemcode,Itemname,Uom,Qty,Rate,Amount,Groupcode,Subgroupcode,Void)
	VALUES ('+char(39)+ltrim(rtrim(@KOTNO))+char(39)+','+char(39)+ltrim(rtrim(@KOTDETAILS))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@KOTDATE))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@POSCODE))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@POSCODE))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@ITEMCODE))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@ITEMDESC))+CHAR(39)+','+CHAR(39)+LTRIM(RTRIM(@UOM))+CHAR(39)+','+RTRIM(LTRIM(@Qty))+','+RTRIM(LTRIM(@Rate))+','+RTRIM(LTRIM(@Amount))+','+CHAR(39)+@GROUPcode+CHAR(39)+','+CHAR(39)+@SUBGROUPCODE+CHAR(39)+','+CHAR(39)+@DELFLAG+CHAR(39)+')'
	PRINT (@SSQL)
	EXEC (@SSQL)
	Fetch CURPROC into @GROUPCODE,@SUBGROUPCODE,@POSCODE,@KOTNO,@KOTDETAILS,@KOTDATE,@ITEMCODE,@ITEMDESC,@UOM,@QTY,@RATE,@AMOUNT,@DELFLAG
End
CLOSE CURPROC
DEALLOCATE CURPROC
---BOM_DET
PRINT 'BOM_DET'
SET @SSQL=''
Set @SSQL='SELECT ISNULL(C.GGROUPCODE,'+CHAR(39)+''+CHAR(39)+') AS GROUPCODE,ISNULL(C.GSUBGROUPCODE,'+CHAR(39)+''+CHAR(39)+') AS SUBGROUPCODE,ISNULL(A.POSCODE,'+CHAR(39)+''+CHAR(39)+') AS POSCODE,ISNULL(A.KOTNO,'+CHAR(39)+''+CHAR(39)+') AS KOTNO,ISNULL(A.KOTDETAILS,'+CHAR(39)+''+CHAR(39)+') AS KOTDETAILS,CAST(CONVERT(CHAR(39),ISNULL(A.KOTDATE,'+CHAR(39)+''+CHAR(39)+'),106) AS DATETIME) AS KOTDATE,ISNULL(C.GITEMCODE,'+CHAR(39)+''+CHAR(39)+') AS ITEMCODE,ISNULL(C.GITEMNAME,'+CHAR(39)+''+CHAR(39)+') AS ITEMDESC,ISNULL(C.GUOM,'+CHAR(39)+''+CHAR(39)+') AS UOM,ISNULL(ISNULL(A.QTY,0)*ISNULL(C.GQTY,0),0) AS QTY,ISNULL(A.RATE,0) AS RATE,ISNULL(A.AMOUNT,0) AS AMOUNT,ISNULL(A.DELFLAG,'+CHAR(39)+''+CHAR(39)+') AS DELFLAG FROM KOT_DET A,INVENTORYITEMMASTER D,STOREMASTER B,BOM_DET C WHERE A.ITEMCODE=C.ITEMCODE AND A.UOM=C.ITEMUOM AND ISNULL(C.VOID,'+CHAR(39)+''+CHAR(39)+')<>'+CHAR(39)+'Y'+CHAR(39)+' AND D.STORECODE='+CHAR(39)+'MNS'+CHAR(39)+' AND D.ITEMCODE=A.ITEMCODE AND A.POSCODE=B.STORECODE AND ISNULL(A.KOTSTATUS,'+CHAR(39)+'N'+CHAR(39)+')='+CHAR(39)+'N'+CHAR(39)+' AND ISNULL(A.DELFLAG,'+CHAR(39)+''+CHAR(39)+')<>'+CHAR(39)+'Y'+CHAR(39) +'AND A.KOTDATE BETWEEN '+CHAR(39)+@FROMDATE+CHAR(39)+' AND '+CHAR(39)+@TODATE +CHAR(39) + 'ORDER BY A.ITEMCODE'
set @SQL='DECLARE CURPROC CURSOR FOR ' + @ssql
PRINT (@SQL)
exec (@SQL)

open CURPROC
Fetch CURPROC into @GROUPCODE,@SUBGROUPCODE,@POSCODE,@KOTNO,@KOTDETAILS,@KOTDATE,@ITEMCODE,@ITEMDESC,@UOM,@QTY,@RATE,@AMOUNT,@DELFLAG
while @@fetch_Status=0
Begin
	SET @SSQL=''
	Set @SSQL='INSERT INTO SUBSTORECONSUMPTIONDETAIL(Docno,Docdetails,Docdate,Storelocationcode,STORELOCATIONNAME,Itemcode,Itemname,Uom,Qty,Rate,Amount,Groupcode,Subgroupcode,Void)
	VALUES ('+char(39)+ltrim(rtrim(@KOTNO))+char(39)+','+char(39)+ltrim(rtrim(@KOTDETAILS))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@KOTDATE))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@POSCODE))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@POSCODE))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@ITEMCODE))+CHAR(39)+','+CHAR(39)+ltrim(rtrim(@ITEMDESC))+CHAR(39)+','+CHAR(39)+LTRIM(RTRIM(@UOM))+CHAR(39)+','+RTRIM(LTRIM(@Qty))+','+RTRIM(LTRIM(@Rate))+','+RTRIM(LTRIM(@Amount))+','+CHAR(39)+@GROUPcode+CHAR(39)+','+CHAR(39)+@SUBGROUPCODE+CHAR(39)+','+CHAR(39)+@DELFLAG+CHAR(39)+')'
	PRINT (@SSQL)
	EXEC (@SSQL)
	Fetch CURPROC into @GROUPCODE,@SUBGROUPCODE,@POSCODE,@KOTNO,@KOTDETAILS,@KOTDATE,@ITEMCODE,@ITEMDESC,@UOM,@QTY,@RATE,@AMOUNT,@DELFLAG
End
CLOSE CURPROC
DEALLOCATE CURPROC
PRINT 'OVER'
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



